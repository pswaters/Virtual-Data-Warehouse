--
-- Link Satellite View definition for {{mainTable}}
-- Generated at {{generationDateTime}}
--
GO
USE [{{metadataConfiguration.persistentStagingDatabaseName}}]
GO

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[{{metadataConfiguration.vedwSchemaName}}].[{{mainTable}}]') AND type in (N'V'))
DROP VIEW [{{metadataConfiguration.vedwSchemaName}}].[{{mainTable}}]
GO

CREATE VIEW [{{metadataConfiguration.vedwSchemaName}}].[{{mainTable}}] AS
SELECT hub.*
FROM (
{{#each individualSourceToTargetMapping}}{{#if @first}}
SELECT
    HASHBYTES('MD5',
   {{#each businessKey}}{{#each businessKeyComponentMapping}}
      ISNULL(RTRIM(CONVERT(NVARCHAR(100), {{targetColumn.columnName}})), 'N/A') + '#~!' {{#unless @last}}+{{/unless}}
    {{/each}}{{/each}}
    ) AS {{targetTableHashKey}},
    -1 AS {{../metadataConfiguration.etlProcessAttribute}},
    {{../metadataConfiguration.loadDateTimeAttribute}},
    {{../metadataConfiguration.recordSourceAttribute}},
    {{#each businessKey}}{{#each businessKeyComponentMapping}}
    {{targetColumn.columnName}},
    {{/each}}{{/each}}
    ROW_NUMBER() OVER (PARTITION BY   {{#each businessKey}}{{#each businessKeyComponentMapping}}
{{targetColumn.columnName}}{{#unless @last}},{{/unless}}{{/each}}{{/each}} ORDER BY {{../metadataConfiguration.loadDateTimeAttribute}}) AS ROW_NR
FROM {{/if}}{{/each}}
(
    {{#each individualSourceToTargetMapping }}
    SELECT
    {{#each businessKey}}{{#each businessKeyComponentMapping}}
        CONVERT(NVARCHAR(100),{{sourceColumn.columnName}}) AS [{{targetColumn.columnName}}],
    {{/each}}{{/each}}
        {{../metadataConfiguration.recordSourceAttribute}},
        MIN({{../metadataConfiguration.loadDateTimeAttribute}}) AS {{../metadataConfiguration.loadDateTimeAttribute}}
    FROM {{sourceTable}}
    WHERE
     {{#each businessKey}}{{#each businessKeyComponentMapping}}
        {{sourceColumn.columnName}} IS NOT NULL {{#unless @last}}AND{{/unless}} {{/each}}{{/each}}{{#if filterCriterion}}AND {{filterCriterion}}{{/if}}
    GROUP BY
     {{#each businessKey}}{{#each businessKeyComponentMapping}}{{#unless sourceColumn.columnType}}
        {{sourceColumn.columnName}},
    {{/unless}}
    {{/each}}{{/each}}
        {{../metadataConfiguration.recordSourceAttribute}}
    {{#unless @last}}UNION{{/unless}}
    {{/each}}
) HUB_selection
) hub
WHERE ROW_NR = 1
UNION
SELECT 0x00000000000000000000000000000000,
- 1,
'1900-01-01',
'Data Warehouse',
{{#each individualSourceToTargetMapping}}{{#if @first}}
    {{#each businessKey}}{{#each businessKeyComponentMapping}}
NULL,
{{/each}}{{/each}}{{/if}}{{/each}}
1 AS ROW_NR
